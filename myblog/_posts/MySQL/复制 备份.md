---
title: 复制 备份
date: 2018-04-09 17:03:14
categories: DB
tags: [DB, MySQL]
---
[toc]
MySQL 服务可以在一台服务器上启动多个，也可以分布在不同的服务器上。其内建的复制功能是构建大型、高性能、高可用、可扩展、灾难恢复、备份以及数据仓库用程序的基础。使用所谓“水平扩展”架构，通过为服务器配置一个/多个备用库（从库）的方式来进行数据同步。

# 复制解决的问题
## 数据分布
多数据中心，使得数据分布在不同地理位置。

## 负载均衡
通过复制将数据的读操作分布到多个服务器上，实现对读密集型应用的优化。实现上可以使用 DNS 轮询，也可以添加网络负载均衡解决方案的思路。

## 备份
复制是备份的技术补充。

## 高可用性和故障切换
帮助应用避免数据库单点失败，包含复制的故障切换系统能够显著缩短宕机时间。

# MySQL 复制
## 复制方式
复制不会增加主库的开销，主要是启用二进制日志的开销。MySQL 支持两种复制方式：

### 基于语句的复制
也称逻辑复制。主库会记录那些造成数据更改的查询，当备库读取并重放这些事件时，实际上时把主库上执行过的 SQL 在本地再执行一遍。这种方式并不常见。
* 好处
实现简单，并且保持二进制日志里的事件紧凑，所以不会造成太大的带宽压力：语句本身很小，但可能执行数据量很大的操作。
* 缺点
主要是主库和备库执行语句的时间异步造成的问题。二进制日志中的查询语句外，还包含有时间戳等元数据；有些特殊语句可能无法正确复制；存储过程和触发器在该模式下也可能存在问题；并且更新必须时串行的，这需要更多的锁。

### 基于行的复制
MySQL 5.1 开始支持，跟其他数据库实现比较相似：将实际数据记录到二进制文件中，备库直接读取并重放这些数据。好处是能够正确复制每一行；但该模式很难进行时间点恢复。

### 对比
二者并不能定性言明孰优孰劣，比如逻辑复制如果语句执行量很大但产生的结果很少，那么显然使用行复制更好；相应如果执行语句开销小于复制大量数据，那么应该使用逻辑复制。所以 MySQL 的实现是，根据需要在这两种复制模式之间动态切换：默认使用基于语句的复制，如果发现语句无法被正确复制，就切换到基于行的复制模式。

### 基于 GTID 的复制
MySQL 5.6.5 新增的复制方式（但可能到 MySQL 5.7 才真正支持并行复制）。
GTID (Global Transaction ID)，一个已提交事务的编号，全局唯一，实际上由 UUID+TID 组成，其中 UUID 是一个 MySQL 实例的唯一标识；TID 代表了该实例上已经提交的事务数量，并且随着事务提交单调递增。
采用了新的复制协议：支持以全局统一事务 ID (GTID) 为基础的复制。当在主库上提交事务或者被从库应用时，可以定位和追踪每一个事务。GTID 复制是全部以事务为基础，使得检查主从一致性变得非常简单。如果所有主库上提交的事务也同样提交到从库上，一致性就得到了保证。

[参考：GTID 复制](https://www.hi-linux.com/posts/47176.html)

## 步骤概述
{% asset_img 主从复制步骤.PNG 主从复制步骤 %}
1. 在主库上把数据更改记录到二进制日志中（这些记录被称为二进制日志事件）；
2. 备库将主库上的日志复制到自己的中继日志（Relay Log）中；
3. 备库读取中继日志中的事件，将其重放到备库数据上。

# 复制配置
## 基本步骤（新安装配置）
此时各服务器上数据一致（都没有或数据相同），然后通过配置主从关系开始复制。
1. 在每台服务器上创建复制账号；
2. 设置主库和备库；
3. 通知备库连接到主库并从主库复制数据。

### 创建复制账号
MySQL 会赋予一些特殊权限给复制线程。在备库运行的 I/O 线程会建立一个到主库的 TCP/IP 连接，这意味着必须在主库创建一个用户，并赋予其合适的权限。备库 I/O 线程以该用户名连接到主库并读取其二进制日志。创建语句：
```sql
mysql> GRANT REPLICATION SLAVE, REPLICATION CLIENT ON *.*
    -> TO repl@'host' IDENTIFIED BY 'password',; 
```
需要在主库和备库都创建该账号。

### 配置主库和备库
在主库（server1）上开启一些设置，需要打开二进制日志，并指定一个独一无二的服务器 ID（server ID），在主库的 my.cnf 文件中配置相关项。备库上也需要相似的配置，还有中继日志目录等。

### 启动复制
告知备库如何连接到主库并重放二进制日志。可以通过配置文件配置，但一般使用"CHANGE MASTER TO"语句设置，后一种方式在后续指向别的主库时无需重启备库。然后执行复制命令。

## 从另一台服务器开始复制
上面全新安装的配置并非一般情况，更多的是，（新配置安装的）备库从一台已经运行了一段时间的主库复制数据，此时数据是不一致的：主库有数据，备库没有数据。这也可以看作备库的初始化。
方法有：
* 从主库复制数据
* 从另一台备库克隆数据 
* 使用最近的一次备份数据来启动备库


# MySQL 备份
复制是备份的手段。

## 备份方式
### 按备份操作方式
**逻辑备份**
**优点**
* 可以用编译器或像 grep 和 sed 之类的命令查看和操作的普通文件；
* 恢复简单，非常灵活；
* 与存储引擎无关。
**缺点**
* 还原时需要 MySQL 加载和解释语句，转化为存储格式，并重建索引，所以会比较慢；
* 无法保证导出后再还原出来的一定是同样的数据。浮点数、软件BUG等都会导致问题；
* 必须由数据库服务器完成生成逻辑备份的工作，因此要使用更多的CPU周期。

**物理备份**
**优点**
* 基于文件的物理备份，只需要将需要的文件复制到其他地方即可完成备份；
* 恢复更简单；
* 恢复快，因为 MySQL 服务器不需要执行任何SQL或构建索引。
**缺点**
* InnoDB 的原始文件通常比相应的逻辑备份要大得多；
* 物理备份不总是可以跨平台、操作系统及 MySQL 版本。文件名大小写敏感和浮点格式可能会遇到麻烦。

### 按是否备份全部数据
* 完全备份
* 增量备份
* 差异备份
一般是组合使用：完全+增量；完全+差异。

## 备份工具
### mysqldump

### mysqlbinlog

### Xtrabackup

http://www.cnblogs.com/yuyue2014/p/3650117.html