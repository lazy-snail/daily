---
title: 中断和异常
date: 2018-04-11 20:49:21
categories: OS
tags: OS
---
概念上二者并非界限清晰。
* 从 OS （操作系统）层面，定义偏向于使用“中断”：
中断分为同步（synchronous）中断和异步（ssynchronous）中断，同步中断是当指令执行时由 CPU 控制单元产生的，之所以称为同步，是因为只有在一条指令终止执行后 CPU 才会发出中断；异步中断是由其他硬件设备依照 CPU 时钟信号随机（任何时候）产生的。（UTLK、LKD、APUE）
* 从 CA （计算机体系结构）层面，如 CSAPP 中解释：处理器把同步和异步中断分别称为异常（exception）和中断（interruption），并将所有的异常分为 4 类（）：
> （异步的）中断；
> （同步的）陷阱；
> （同步的）故障；
> （同步的）终止；

但本质上趋同的观点是可以使用 **中断信号** 来指代二者（同步和异步），且中断一般指 I/O 设备也就是硬件发出的异步信号（非指令产生），异常一般指处理器本身产生的同步信号（该同步信号一般由操作系统/应用程序指令产生，交送处理器处理）。以下使用中断（异步异常）和异常（同步异常）表述。

# 异常控制流
（CSAPP）Exceptional Control Flow，ECF，异常控制流，也就是异常/中断，导致正常的处理器控制流发生突变来应对异常事件。ECF 发生在计算机系统的各个层次：硬件层，硬件检测到的事件会触发控制转移到异常处理程序；操作系统层，内核通过上下文切换将控制从一个用户进程转移到另一个用户进程；应用层，一个进程可以发送信号到另一个进程，而接收者会将控制转移到它的一个信号处理程序。

## ECF 重要作用
* 是操作系统实现 I/O、进程和虚拟内存的基本机制；
* ECF 是计算机系统实现并发的基本机制；
* 应用程序通过使用一个陷阱（trap）/系统调用（system call）的 ECF 形式，向操作系统请求服务。比如向磁盘写数据，从网络读数据、创建新进程等，都是通过应用程序调用系统调用实现的；
* 通过 ECF 理解软件层面异常如何工作。C++、java 等语言都是通过 try...catch...throw 语句来提供软件异常机制。软件异常允许程序进程非本地跳转（即违反通常的调用/返回栈规则的跳转）来响应错误情况。而非本地跳转是一种应用层 ECF，理解这些低级实现有助于理解高级软件异常的实现机制。etc

**中断机制：让硬件在需要的时候向内核发出信号。**
中断本质上是一种特殊的电信号，由硬件设备发向处理器。处理器接收中断后，会马上向 OS 反映此信号的到来，然后 OS 负责处理这些新到来的数据。中断可以随时产生，因此内核随时可能因为新到来的中断而被打断。
{% asset_img 中断路由.PNG 中断从硬件到内核的路由 %}

**中断处理程序**
在响应一个特定中断的时候，内核会执行一个函数，该函数叫做中断处理程序（interrupt handler）或中断服务例程（Interrupt service routine，ISR）。每种类型的中断都有一个相应的中断处理程序。一个设备的中断处理程序是其设备驱动程序（driver）的一部分——设备驱动程序是用于对设备进行管理的内核代码。

中断处理程序与其它内核函数真正的区别在于，中断处理程序是被内核调用来响应中断的，而它们运行于一个被称为**中断上下文（Interrupt context）**的特殊上下文中（也成原子上下文），该上下文中的执行代码不可阻塞。

**上半部分与下半部分**
鉴于中断处理程序既要运行得快，又要完成很多的工作量，一般把中断处理程序分为两个部分：
* 上半部（top half）：中断处理程序，接收到一个中断，立即开始执行，但只做有严格时限的工作，例如对接收的中断进行应答或复位硬件，该阶段可能禁止一些/全部其它中断；
* 下半部（bottom half）：能够被允许稍后完成的工作推迟到这个部分来完成，在合适的时机，下半部开始执行，该阶段可以响应所有中断。
_以网卡为例_ TBA

三种下半部接口：
* 软中断：中断上下文，相同类型的也允许同时执行，数据被软中断共享情况下需要锁；
* tasklet：中断上下文，自己负责执行的序列化保障，相同类型的tasklet不允许同时执行，所以不需要锁；
* 工作队列：进程上下文，需要锁来避免数据共享等问题。

**中断上下文（interrupt handler）**
（对比进程上下文），中断上下文和进程没有什么关系，与 current 宏也无关（尽管它会指向被中断的进程）。因为没有后备进程，中断上下文不睡眠（一旦睡眠就无法重新调度了）。因此不能从中断上下文调用某些（能够睡眠的）函数。
中断上下文打断了其它代码的执行（甚至打断在其他中断线上的另一中断处理程序），因此有严格的时间限制，应当迅速、简洁地完成，尽量不要用循环去处理繁重的工作。尽量把工作从中断处理程序（上半部）分离出来，放到下半部去执行。
中断处理程序的栈空间是专用的一个页，在 32 系统上为 4 KB。编写中断处理程序可以不关心栈如何设置或大小，但要尽量节约内核栈空间。
