---
title: 事务隔离
date: 2018-04-09 14:31:19
categories: DB
tags: [DB, MySQL]
---
[toc]


# 数据库操作面临的问题
* **更新丢失**
两个事务同时更新某一行数据，可能会导致一个事务的更新将另一个事务的更新给覆盖了的情况。这是因为没有锁，导致事务没有正确隔离开。
当前多数数据库事务隔离的最低级别也都能保证不会发生更新丢失问题。

* **脏读**
指当一个事务正在访问数据，并且对数据进行了修改，而这种修改还没有提交到数据库中，此时，另外一个事务也访问了这个数据，然后使用了这个数据。由于这个数据是还没有提交的数据，那么另外一个事务读到的这个数据就是脏数据，依据脏数据所做的操作可能是不正确的。

* **不可重复读**
指在一个事务中，多次取读同一数据集合，在这个事务还没有结束时，另一个事务也访问该数据集合，并且做了一些 DML 操作。那么，在第一个事务中的两次读取数据之间，由于第二个事务的修改，导致两次读到的数据可能是不一致的。这样就发生了在一个事务中两次读到的同一数据却不一样的情况，即不可重复读。
脏读读取的是未提交的数据，而不可重复读读取的是已提交的数据，但该提交违反了数据库事务的 **一致性** 要求。

* **幻读**
指当事务不是独立执行时发生的一种现象：如一个事务对一个表中的数据进行了修改，这种修改涉及到表中的全部数据行，同时，另一个事务也修改这个表中的数据，其操作是插入/删除一行数据。那么，第一个事务就会发现表中的数据没有被完全修改，好像发生了幻觉一样，即幻读。

为了避免以上情况，标准 SQL 规范中定义了 4 个事务隔离级别。不同隔离级别对事务的处理不同。

# 隔离级别
SQL 标准定义了四个隔离级别：
## READ UNCOMMITTED
未提交读/未授权读。**不允许丢失更新，但允许脏读**。如果一个事务已经开始写数据，则其他事务不允许同时进行写操作，但允许其他事务读取该数据。该隔离级别可通过 **排他写锁** 实现。

## READ COMMITTED
提交读/授权读。**不允许脏读，但允许不可重复读**。可通过 **瞬间共享读锁** 和 **排他写锁** 实现。读取数据的事务允许其他事务继续访问该数据，但是未提交的写事务将会禁止其他事务访问该行。

## REPEATABLE READ
可重复读。**不允许不可重复度，有可能出现幻读**。可通过 **共享读锁** 和 **排他写锁** 实现。读取数据的事务不允许其他写事务，允许其他读事务；写事务不允许其他任何事务。

## SERIALIZABLE
可串行化。提供最高级别的事务隔离，它强制事务序列化执行（可以看作串行），事务只能一个接一个地执行，不能并发执行。仅仅通过“行级锁”是无法实现事务序列化的，必须通过其他机制保证新插入的数据不会被刚执行查询操作的事务访问到。

事务的隔离级别越高，越能保证数据访问的完整性和一致性，相应地对并发性能的影响也越大。对于多数应用程序，可以优先考虑把数据库系统的隔离级别设置为 **Read Commited**，它能够避免脏读，且具有较好的并发性能，尽管可能会导致不可重复读、幻读等并发问题，但在这些场景下由应用程序采用乐观锁/悲观锁，能够有效控制并发问题。

# MySQL 事务隔离级别
InnoDB 默认的隔离级别是 REPEATABLE READ，与标准 SQL 不同的是，该级别下，InnoDB 使用 Next-Key Lock 锁算法避免幻读的产生。所以在该级别下已经完全能够保证事务的隔离性要求，即达到 SQL 标准的 SERIALIZABLE 隔离级别。MVCC 的具体实现一般很难达到（解决幻读问题）要求，所以各数据库采用了不同的方案，InnoDB 存储引擎采用 Next-Key Lock 锁算法来解决幻读问题。
隔离级别越低，事务请求的锁越少或保持锁的时间越短。SERIALIZABLE 隔离级别几乎不会带来性能问题，同样地，即使使用 READ COMMITTED 的隔离级别，也不会得到性能的大幅度提升。


# 相关概念
**脏页**
指缓冲池中已经被修改的页，但还没有刷新回磁盘，即数据库实例内存中的页和磁盘中的页的数据是不一致的。
对脏页的读取是正常现象，因为数据库实例内存到磁盘是异步的，这并不影响数据的一致性（或者说二者最终会达到一致性，即当脏页都刷新回磁盘）。这里的异步刷新并不影响数据库的可用性，因此可以带来性能的提高。

**脏数据**
指事务对缓冲池中行记录的进行修改，但修改还没有被提交（commit）。
读脏数据（脏读）就不同了，由于脏数据是某个事务还未提交的已修改数据，此时能被其他事务读取到，显然违背了事务的隔离性。

https://blog.csdn.net/claram/article/details/51646808