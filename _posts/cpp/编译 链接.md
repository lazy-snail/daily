---
title: 编译 链接
date: 2018-05-22 16:20:41
categories: cpp
tags: cpp
---
# 过程
gcc 编译过程可以分为几个步骤：预处理/预编译、编译、汇编、链接：
{% asset_img 流程.png 流程 %}
实际上 gcc 这个命令本身只是 编译器（包括执行预编译阶段） ccl/cclplus、汇编器 as、链接器 ld 的包装，gcc 根据不同参数要求去调用它们，所以即使使用 gcc 将所有命令一步执行到位得到可执行文件，其过程也是按这几个主要步骤执行的。

## 预处理
一般 gcc -E 结果 xxx.c 生成 xxx.i，xxx.cpp 生成 xxx.ii，但后缀并不严格限制。主要完成这些工作：
* 展开所有宏定义 #define，即将它们复制到所有出现的地方；
* 处理所有条件编译指令：#if、#ifdef、#elif、#else、#endif 等；
* 递归处理"#include"预编译指令，将所有被包含的文件插入该预编译指令的位置；
* 删除所有注释；
* 添加行号和文件名标识，编译时编译器产生的编译错误/警告等需要用到；
* 保留所有 #pargma 编译器指令。

## 编译
编译过程就是编译器把预处理过的文件进行一系列词法分析、语法分析、语义分析以及 **优化**，产生汇编代码文件。这是核心和最复杂的部分：
{% asset_img 编译过程.png 编译过程 %}
（参见《自我修养》）

## 汇编
汇编器将编译后的汇编代码转变成机器可执行的指令，每个汇编语句几乎都对应一条机器指令。所以汇编过程相比于编译过程比较简单。它不需要指令优化，没有复杂的语法语义，只需要根据汇编指令和机器指令的对照一一翻译即可。

## 链接
链接比较复杂，涉及到动态/静态库等内容。本质上是代码/程序的模块化（或者说随着代码/程序规模的不断增加，模块化是一种必然的进化方向），需要组合拼装成完整的一个可执行程序，这就需要将这些模块链接起来。而静态链接、动态链接等都是不断发展不断优化的产物/思想。
链接过程主要包括 **地址和空间分配（Address and Storage Allocation）、符号决议（Symbol Resolution）/符号绑定（Symbol Binding）、重定位（Relocation）**。

## 一些选项
* 优化
> -O：主要进行线程跳转（Thread Jump）和延迟退栈（Deferred Stack Pops）两种优化，减小代码的尺寸和运行时间，但不会增加编译时间；
> -O2：除了完成 -O1（也就是 -O），不需要额外的空间去加速交换；
> -O3：在 O2 基础上，忽略了有可能增加代码长度的部分，并且增加了减小代码长度的优化；
> -Os：在 O2 基础上，包括循环展开和其他一些与处理器特性相关的优化工作，增加了内联函数和重名 register，不过可能导致编译出来的二级制程序不能debug；
另外，还有一些优化参数，-mcpu 会针对某一型号的 CPU 进行调优而不会导致它不能在另外的 CPU 上运行等。
* 调试信息：使用 -gxxx 产生符合操作系统本地格式的调试信息
> -ggdb：产生 GDB 所需的调试信息。这是可用的、最具表达力的格式；
> -gstabs：产生 stabs 格式的调试信息（如果支持的话），其中不包含 GDB 扩展。用于 DBX 调试器；
> -gstabs+：产生 stabs 格式的调试信息（如果支持的话），并且会使用只有 GNU 调试器（GDB）才理解的 GNU 扩展。这些扩展的使用可能会导致其他调试器崩溃或者拒绝读取编译出来的可执行程序；
> -gxcoff：产生 XCOFF 格式的调试信息（如果支持的话），用于 DBX 调试器。
> -gxcoff+：同 -gxcoff，"+"具有和 "-gstabs+" 相同的限制语义。
* 警告 错误
> -w：禁止所有告警信息；
> -Wall：输出所有的常见警告,另外的一些不常见的告警不在这个范围内；
> -Werror：把所有的警告信息转化为错误信息，并在出现警告时停止向下编译；
> -pedantic：发出 ANSI C 标准所列的全部警告信息，如果使用了 GCC 对 C 语言的扩展，则提示一个告警信息；
> -pedantic-error：发出 ANSI C 标准所列的全部错误信息，如果使用了 GCC 对 C 语言的扩展，则提示一个错误信息；
* -I dir：除了当前目录，还在 dir 寻找头文件、源文件；
* -L dir：搜索除系统标准库目录外的 dir 目录，作为库文件来源；
* -static：指示链接器构建一个完全链接的可执行程序，即链接静态库而不链接动态库；
* -fPIC：指示链接器创建一个共享的目标文件，即 .so 文件;
* -shared：生成动态库，一般和 -fPIC 一起使用。

[关于 gcc](https://www.jianshu.com/p/b8ddb4cee7af)


