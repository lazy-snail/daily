---
title: IP
date: 2018-04-02 14:37:25
categories: CN
tags: CN
---
**网络层提供的不可靠、无连接数据报传送服务**。
*不可靠（Unreliable）：* 不能保证IP数据报成功到达目的地，简单处理错误的方式如：丢弃数据报，发送TCMP消息报给信源端。
*无连接（Connectionless）：* 不维护任何关于后续数据报的状态信息，即独立处理，独立到达（不同路线的选择可能造成失序、丢失等）。

# IP 数据报首部格式
数据报首部（20字节+选项内容）包含的内容如下：
{% asset_img IP-header.gif IP 首部 %}
IP 长度字段要求首部始终是 32 bit 的倍数，所以选项内容有可能需要填 0 补充。

## 4 位版本号
目前有 IPv4、IPv6；

## 4 位首部长度
首部中 32 bit 字的数目，即首部长度最多只能有 60 字节（20 + 最多 40 选项字段）。普通 IP 数据报（不含选项内容）该字段值为5（5 * 4 byte，即 20 字节）；
## 8 位服务类型（TOS）
包括 3 bit 优先权子字段（已被忽略），4 bit 的 TOS 子字段和 1 bit 未用但必须置 0，4 bit 分别为：
* 最小时延
* 最大吞吐量
* 最高可靠性
* 最小费用

4 bit 中只能置其中 1 bit，均为 0 代表是一般服务。（RFC 1349）推荐的 TOS 值有：
* 最小时延：Telnet、FTP（控制连接）、SMTP（命令阶段）、DNS（UDP查询）等；
* 最大吞吐量：FTP（数据连接）、SMTP（数据阶段）、DNS（区域传输）等；
其他略。
并且，现在大多数 TCP/IP 实现都不支持 TOS 特性。

## 16 位数据报(字节数)
整个 IP 数据报的长度：首部+数据。最大 65535 字节（16位），当数据被分片时，该字段的值也随之变化。

## 16 位标识（Identificationr）
唯一标识主机发送的每一份数据报，通常每发送一份其值加 1。也能和标志位、片偏移联合使用，对较大的上层数据报进行分片和重新组装（重组时有足够的信息处理片失序）。
## 3 位标志（Flags）
第一位不用，第二位为 DF（Don't Fragment），置 1 表示不分片（如果导致无法转发，则丢弃该数据报并返回错误信息），第三位为 MF（More Fragments），如果 DF 为 0，那么 MF 除最后一片外，其他每个组成片都置 1；
## 13 位片偏移（Offset）
该片偏移原始数据报开始处（可通过总长-首部长获得）的位置；

## 8 位生存时间（TTL）
设置了数据报最多可经过的路由器数量。由发送端主机设置（通常为 32 或 64），每经过一个处理该报文段的路由器，该值减 1。当该值减为 0 时，数据报被丢弃，并发送 ICMP 报文通知发送端主机；
## 8 位协议
识别向 IP 传送数据报的协议类型
* TCP（6）
* UDP（17）
* ICMP（1）
* IGMP（2）
* OSPF（89）
...

## 16 位首部检验和
只计算首部，对首部中每个二进制 16 位进行反码求和。TTL 递减的情况可以通过递增检验和解决而无需重新计算整个首部；
## 32 位源 IP 地址
发送端主机IP地址；
## 32 位目的 IP 地址
接收端主机IP地址；

## 选项内容
变长，一般有：
* 安全和处理限制（军事领域）；
* 记录路径（由于4位首部长限制导致该选项现今已无用处）；
* 时间戳（让每个路由器都记录下它的IP地址和时间）；
* 宽松的源站选路（为数据报指定一系列必须经过的IP地址）；
* 严格的源站选路（与上面的类似，但要求只能经过指定的这些地址，不能经过其他地址）。

这些选项都以 32 bit 为界限，必要时插入值为 0 填充字节（IP 长度字段要求首部始终是 32 bit 的倍数）。实际上这些选项很少被使用，也并非所有主机和路由器都支持它们。

# IP 数据报分片
物理网络层要求限制每次发送数据帧的最大长度。任何时候 IP 层收到一份要发送的数据报时，要判断向哪个接口发送数据（选路），并查询该接口的 MTU（最大传输单元）。IP 把 MTU 与数据报长度对比，按需分片。分片过程可以发生在原始发送到主机上，也可以发生在中间路由器上。但重新组装要在目的端 IP 层完成：实现分片与重新组装最运输层是透明的。尽管透明，但即使只丢失一个分片，也要重传整个数据报（IP 层没有超时重传机制），因此要尽量避免分片。

# IP 编址
相关概念：DHCP、NAT、CIDR

## NAT
Network Address Translation，网络地址转换。
示例（见 CNATD p234）：
{% asset_img NAT示例.PNG "NAT 示例"%}

### 关于 NAT 的讨论
一般认为端口号用于进程编址，而非主机编址；并且 NAT 违反了端到端原则（主机之间应该直接对话），节点（NAT 路由器）不应介入修改 IP 地址与端口号；应该使用 IPv6 解决 IP 地址短缺问题，而非如 NAT 之类的权宜之计来修补。

# IPv6
{% asset_img IPv6数据报格式.PNG IPv6数据报格式 %}