---
title: 硬链与软链
date: 2018-04-23 20:33:22
tags: [Linux, OS]
---
**文件**
现代 OS 为解决信息能独立于进程之外被长期存储引入了文件。Unix 系统中除进程外，一切皆是文件，Linux 与之一脉相承。
Linux 不区分文件和目录：目录是记录了其他文件名的文件。_因此，使用 mkdir 创建目录时，若期望创建目录的名称与现有的文件名/目录名重复，则会创建失败。_

**inode**
一般，文件包括文件名和数据。Linux 称之为用户数据（user data）和元数据（metadata）：
* 用户数据：即文件数据块（data block），数据块是记录文件真实内容的地方。
* 元数据：文件的附加属性，文件名 + inode，即索引节点号，它是文件的唯一标识（而不是文件名，文件名只是方便人们记忆和使用）。

即，除了文件名以外的所有文件信息，都保存在 inode 中。主要包括：
* 文件的字节数；
* 文件拥有者的 User ID；
* 文件的 Group ID；
* 文件的读、写、执行权限；
* 三个时间戳：ctime：inode 上一次变动的时间，mtime：文件内容上一次变动的时间，atime：文件上一次打开的时间；
* 链接数：即有多少文件名指向这个 inode；
* 文件数据 block 的位置。

目录文件的链接数比较特殊：创建目录时，默认会生成两个目录项，“.”和“..”，前者的 inode 号就是当前目录的 inode 号，等同于当前目录的“硬链接”；后者的 inode 号就是当前目录的父目录的 inode 号，等同于父目录的“硬链接”。所以，任何一个目录的“硬链接”总数，总是等于 2 + 子目录总数（含隐藏目录）。

OS（Unix, Linux）使用 inode 号识别不同的文件。
当读取某个文件时，必须经过文件名指向其 inode 号，获取 inode 信息，再根据该信息，找到文件数据所在的 block，完成数据读取。
{% asset_img 文件组成.jpg 通过文件名打开文件 %}
查看 inode 命令：
* stat filename  # 列出该文件的 inode 号
* ls -i  # 列出文件名和 inode 号

查看 inode 使用情况：
* df -i

OS 将硬盘分为两个区域：数据区，存放文件数据；inode 区（inode table），存放 inode 所包含的信息。
inode 会占用硬盘空间，每个大小一般为 128 字节或者 256 字节。假定 1 GB 硬盘中，每个 inode 大小为 128 字节，每 1 KB 设置一个 inode，则 inode table 占用 128 MB，占总量的 12.8%。
查看 inode 节点大小：
* sudo dumpe2fs -h /dev/sda5 | grep "Inode size"

由于每个文件都会占用一个 inode，所以可能先于硬盘而耗尽，这时，同样无法继续创建新文件。

到此，不难理解目录的权限。目录文件的读权限（r）和写权限（w），都是针对目录文件本身的。由于目录文件内只有文件名和 inode 号，所以如果只有该目录文件的读权限，则只能获取文件名，无法获取其他信息（包括 inode 节点中的信息），从而，读取 inode 节点内的信息需要目录文件的执行权限（x）。

inode 特殊作用
由于 inode 号与文件名分离，导致了 Unix/Linux 系统的一些特有现象：
* 有时，文件名包含特殊字符导致无法删除，这时直接删除 inode 节点，就能起到删除文件的作用；
* 移动/重命名文件，并不影响 inode 号；
* 打开一个文件后，系统就以 inode 号来识别该文件，不再考虑文件名。因此，通常来说，系统无法通过 inode 号得知文件名。

第三点使得软件更新变得简单，可以在不关闭软件的情况下进行更新而不需要重启。更新时，新版文件以同样的文件名，生成一个新的 inode，不会影响到正在运行中的文件。等下一次运行该软件时，文件名就自动指向新版文件，旧版文件的 inode 则被回收。

_为解决文件的共享使用，Linux 引入了两种链接：硬链接（hard link）与软链接（soft link，又称符号链接，symbolic link）。_
链接的好处：
便于文件共享、隐藏文件路径、增加权限安全、节省存储空间等。

**硬链接**
如果一个 inode 号对应多个文件名，则这些文件就是硬链接。即，硬链接就是同一个文件使用了多个别名。因此，其特性有：
* 文件有相同的 inode 和 data block；
* 只能对已存在的文件进行创建；
* 不能跨文件系统进行硬链接的创建 ；
* 不能对目录进行创建，只能对文件创建；
* 删除一个硬链接文件并不影响其他有相同 inode 号的文件。

inode 仅在各文件系统下是唯一的，因此不能交叉文件系统创建硬链接。而现代 Linux 文件系统目录中均隐藏了两个特殊的目录：当前目录（.）和父目录（..），查看其 inode 号可知它们就是两个硬链接，如果允许对目录创建硬链接，则会产生目录环。

**软链接**
如果一个文件的用户数据块中存放的内容是另一个文件的路径名的指向，则该文件就是软链接。即，访问软链接时，系统会自动将访问者导向其数据指向的路径，即另一个文件。除了内容存放的是一个文件路径指向外，可以把它看作一个普通文件，并且软链接占用一个 inode。其特性与硬链接有明显不同：
* 有自己的文件属性及权限等；
* 可对不存在的文件或目录创建软链接；
* 可跨文件系统；
* 可对文件或目录创建；
* 创建软链接时，链接计数 i_nlink 不会增加；
* 删除软链接并不影响被指向的文件，但若被指向的原文件被删除，则相关软连接被称为死链接（即 dangling link，若被指向路径文件被重新创建，死链接可恢复为正常的软链接）。
