---
title: Java-线程
date: 2018-04-14 15:39:53
categories: java
tags: [java, 并发]
---
[toc]
## java 线程
 线程是 java 程序执行的基本模型，也被成为轻量级进程。所有 java 程序至少由一个控制线程组成——即使一个只有 main( ) 函数的程序也是在 JVM 中作为一个线程运行的。
线程允许在同一个进程中同时存在多个程序控制流。共享进程范围内的一些资源：堆资源、内存句柄、文件句柄等；但线程拥有自己的程序计数器（PC）、栈、局部变量等。
大多数现代 OS 中，都是以线程为基本的调度单位，而不是进程。

**停止线程的方法**
* 使用退出标志，即当 run() 方法完成后线程终止，属于正常退出；
* 使用 interrupt() 方法，中断线程；
* _stop()、suspend()、resume()都是作废的方法，会产生不可预料的结果，不建议使用。_

## 竞态条件
当某个计算的正确性取决于多个线程的交替执行时序时，即，正确的结果要取决于运气。如，常见的竞态条件“先检查后执行（Check-Then-Act）”操作，即，通过一个可能失效的观测结果再来决定下一步的动作。

## 活跃性
关注的目标是：某件正确的事情最终会发生。活跃性问题包括死锁、饥饿、活锁等。

## 线程安全的两个方面
线程安全包含 **原子性** 和 **可见性** 两个方面，java的同步机制都是围绕这两个方面来确保线程安全的。
可见性在内存模型中遇到的同步问题有：
* 在编译器中生成的指令顺序，可能与源代码中的顺序不同；
* 编译器会把变量保存到寄存器而不是内存中；
* 处理器可以采用乱序/并行等方式来执行指令；
* 缓存可能会改变将写入变量提交到主内存的次序；
* 保存在处理器本地缓存中的值，对于其他处理器是不可见的；
etc.

这些因素会使得一个线程无法看到变量的最新值，并且会导致其他线程中的内存操作似乎在乱序执行——如果没有使用正确的同步。

## 线程安全的实现方式。
根据应用的不同，多线程环境中，也并非一定需要锁来保证线程安全，只要代码里没有变量互串，线程之间互不影响，就是线程安全的，可以根据 JMM 的先行发生原则进行判断，是否需要以及应该使用哪种级别的线程安全措施。
Java 中线程实现同步的方式主要是关键字 synchronized，它提供了一种独占的加锁方式；同时，“同步”这个术语还包括 volatile 类型变量，显式锁（Explicit Lock）、原子变量，以及，使用硬件支持实现，如 CPU 提供的 CAS 等技术，也能保证多线程环境的安全读写。