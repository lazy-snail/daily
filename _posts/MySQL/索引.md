---
title: 索引
date: 2018-04-06 00:17:10
categories: DB
tags: [DB, MySQL]
---

**索引是数据库中用来加速查询的最为重要的技术手段。**

_为什么不直接对数据进行排序呢？这样就不需要索引了而且能够加速搜索_
如果表只有一个索引，自然可以这样做。如果想添加两个/多个索引，又不能同时按照两种方式对数据进行排序，比如一个关于顾客姓名的索引和一个电话号码索引，这种情况就无法排序。将索引从数据行中整体分离出来，就可以创建多个索引，并且不需要对原始数据排序，但搜索过程即先在索引中找到对应值，然后根据匹配的记录找到对应的数据行。此外，索引行数据通常比表里的数据行更短，插入/删除值时，为保持排序顺序，来回移动较短的索引值，比来回移动较长的数据行更加容易。

# 索引存储：
* 对于MyISAM表，其数据保留在数据文件中，索引值保留在索引文件中，即使用数据的物理位置引用被索引的行，并使用前缀压缩技术使得索引更小，一个表可以有多个索引，但它们都保存在同一个索引文件里。索引文件里的每个索引都由一组有序的关键字行构成，这组关键字行主要用于快速访问数据文件；
* 对于InnoDB表，默认情况下，只是用一个表空间，用于管理所有的InnoDB数据存储和索引存储，也可以修改配置，让它创建的每个表都有自己的表空间，但此时，给定表的数据和索引也同样保存在同一个表空间文件。同样地，InnoDB将索引值当作一组有序值。InnoDB存储引擎表是索引组织表，即表中数据按照主键顺序存放，即根据主键引用被索引的行。

## 使用方式：
* 加快对 WHERE 字句匹配的行进行搜索的速度/加快对与另一个连接表里的行匹配的行进行搜索的速度；
* 对于使用 MIN() 或 MAX() 函数的查询，可以在不用逐行检查的情况下，快速找到索引列里的最值；
* 对于 ORDER BY 和 GROUP BY 字句，MySQL经常使用索引来高效地完成分类/分组操作；
* 通过索引来读取查询所请求的所有信息。

# B+ 树索引（InnoDB）
绝大部分文件目录结构和数据库索引都使用 B 树或其变种B+ 树实现，关系型数据库中最常用、最有效的索引。原因：
* 数据库索引一般数据量很大，超出了内存范围，这时候传统的内存数据结构比如红黑树不再适用，而 B+ 树更适合磁盘数据结构，它通过降低树的高度，来减少磁盘操作，从而提高查询效率。
* Mysql 是一种关系型数据库，区间访问是常见的一种情况，B+ 树叶节点增加的链指针,加强了区间访问性，可使用在范围区间查询等，而 B- 树每个节点 key 和 data 在一起，则无法区间查找。

MySQL 有全键值、键值范围、键前缀查找。具体如下几类：
* 全值匹配：和索引中的所有列进行匹配；
* 匹配最左前缀：比如查找只是用索引的第一列；
* 匹配列前缀：只匹配某一列的值的开头部分；
* 匹配范围值：例如查找姓在 Allen 和 Barrymore 之间的人；
* 精确匹配某一列并范围匹配另一列：如所有姓氏为 Allen 名字是字母 N 开头的人；
* 只访问索引的查询：即查询只需要访问索引，而无须访问数据行。
etc.

## 下面是 B-Tree（不一定只是 B+ 树）索引的一些限制：
* 如果不是按照索引的最左列开始查找，则无法使用该索引；
* 不能跳过索引中的列。即，如果一个索引中含有三个列，则只有在使用了第一、二列的情况下，才能使用第三列；
* 如果查询中有某个列的范围查询，则其右边所有列都无法使用索引查找。如果范围查询列值的数量有限，可以通过使用多个等于条件替代之。
etc.

_特点：_
由于 B+ 索引在数据库中有**高扇出性**的特点，一般高度在2-4层，意即查找某一键值的行记录最多只需要 2-4 次 IO。
可以分为聚集索引（Clustered Index）和辅助索引（Secondary Index），叶子节点存放着所有的数据，不同之处是，叶子节点存放的是否是一整行的信息。
**聚集索引：**
按照每张表的主键构造一棵 B+ 树，同时叶子节点中存放的即为整张表的行记录数据，也将聚集索引的叶子节点成为数据页。聚集索引的这个特性决定了索引组织表中数据也是索引的一部分。同 B+ 树数据结构一样，每个数据页都通过一个双向链表来进行链接。由于实际的数据页只能按照一棵 B+ 树进行排序，因此每张表只能拥有一个聚集索引。查询优化器倾向于采用聚集索引，因为能够在叶子节点上直接找到数据，对于主键的排序查找和范围查找速度都非常快。聚集索引的存储并不是物理上连续的（维护成本将非常高），而是逻辑上连续的。
**辅助索引**
叶子节点并不包含行记录的全部数据，除了包含键值以外，每个叶子节点的索引行中还包含了一个书签，用来告诉InnoDB存储引擎哪里可以找到与索引相对应的行数据。辅助索引的存在并不影响数据在聚集索引中的组织，因此每张表上可以有多个辅助索引。当通过辅助索引来查找数据时，InnoDB存储引擎会遍历辅助索引并通过叶级别的指针获得指向主键索引的主键，然后通过主键索引来找到一个完整的行记录。*例子：如果在一棵高度为3的辅助索引树中查找数据，那么需要对这棵辅助索引树遍历3次找到指定主键，如果聚集索引树的高度同样为3，那么还需要对聚集索引树进行3次查找，最终找到一个完整的行数据所在的页，因此共需要6次逻辑IO访问以得到最终的一个数据页。*

**_B+ 树索引并不能找到一个给定键值的具体行，而是查找该行所在的页，然后通过把页读入内存，再在内存中进行查找，最后得到要查找的数据行。_**

_平衡二叉树_
任何节点的两个子树的高度差最大为1的二叉树。维护的代价很大：需要1次/多次左旋/右旋来得到插入/更新后树的平衡性。

_B+ 树_
简单讲，B+ 树是为磁盘或其他直接存取辅助设备设计的一种平衡查找树。所有记录节点都是按键值的大小顺序存放在同一层的叶子节点上，由各叶子节点指针进行连接。

# 哈希索引（Hash Index）
基于哈希表实现，只有精确匹配索引所有列的查询才有效。对于每一行数据，存储引擎都会对所有的索引列计算一个哈希码（Hash Code），哈希码是一个比较小的值，并且不同键值的行计算出来的哈希码是不同的。哈希索引将所有的哈希码存储在索引中，同时在哈希表中保存指向每个数据行的指针。

MySQL中，只有 Memory 引擎显式支持哈希索引，也是 Memory 引擎表默认索引类型，并且支持非唯一哈希索引。如果多个列的哈希值相同，索引会以链表的方式存放多个记录指针到同一个哈希条目中；
InnoDB 引擎支持的哈希索引是自适应的，会根据表的使用情况自动为表生成哈希索引，不能人为干预是否在一张表中生成哈希索引。

# 全文索引（Full-Text Search Index)
**将存储于数据库中的整本书或整篇文章中的任意内容信息查找出来的技术。**
_MyISAM支持全文索引，InnoDB 从 1.2.x 版本开始支持全文索引。Memory、NDB、Archive等不支持全文索引。_

## 倒排索引
全文索引通常使用倒排索引（Inverted Index）来实现：在辅助表（Auxiliary Table）中存储了单词与单词自身在一个/多个文档中所在位置之间的映射，这通常利用关联数组实现，有两种表现形式：

* Inverted File Index，表现形式为 {单词，单词所在文档 ID}；
* Full Inverted Index，表现形式为{单词，（单词所在文档 ID，在具体文档中的位置1，位置2...）}
示例如下：
{% asset_img 全文索引关联数组示例.PNG 全文索引关联数组示例 %}
## InnoDB 全文索引
采用 Full Inverted Index 的方式，将（DocumentId， Position1, Position2...）视为一个 ilist。故在全文索引的表中，有两个列：word字段、ilist字段，并且在word字段上设有索引。此外，由于 InnoDB 在ilist字段中存放了 Position 信息，故可以进行 Proximity Search（MyISAM不支持该特性）。
为提高全文检索的**并行性能**，InnoDB中共有6张 Auxiliary Table，目前每张表根据 word 的 Latin 编码进行分区。Auxiliary Table 是存放在磁盘上的持久表。此外，还有一个 FTS Index Cache（全文检索索引缓存），用来提高全文检索的行能。它是一个红黑树结构，根据（word，ilist）进行排序。

## 限制：
* 每张表只能有一个全文索引的索引；
* 由多列组合而成的全文索引的索引列必须使用相同的字符集和排序规则；
* 不支持没有单词界定符（delimiter）的语言，如中、日、韩等语言。

## 相关性：
在 WHERE 中使用 MATCH 函数，查询返回的结果是根据相关性（Relevance）进行降序排序的，即相关性最高的结果放在第一位，0表示没有任何相关性。计算条件：

* word是否在文档中出现；
* word在文档中出现的次数；
* word在索引列中的数量；
* 多少个文档包含该word。

## BOOLEAN
全文检索可以使用 IN BOOLEAN MODE 修饰符，此时查询字符串的前后字符会有特殊的含义，如：
* \+ word：表示word必须存在；
* \- word：表示word必须被排除；
* @distance：可选，表示字符字节间距最大值；
* \>：表示出现该词时增加相关性；
* <：表示出现该词时降低相关性；
* \*：表示以该词开头的单词，如lik*，可以是lik、like、likes...
* “：表示短语；
* ~：表示允许出现该单词，但相关性为负
* etc.

## Query Expansion
全文索引的扩展查询，通常在查询的关键词太短，用户需要 implied knowledge（隐含知识）时进行。如，对于单词 database 的查询，用户可能希望查询的不仅仅是 database 的文档，可能还指那些包含 MySQL、Oracle、DB2、RDBMS 等的单词，这时可以使用 Query Expansion 模式来开启全文索引的 implied knowledge。
通过在查询短语中添加 WITH QUERY EXPANSION 或 IN NATURAL LANGUAGE MODE WITH QUERY EXPANSION 可以开启 blind query expansion（automatic relevance feedback）。该查询分为两个阶段：
1. 根据索引的单词进行全文索引查询；
2. 根据第一阶段产生的分词再进行一次全文检索的查询。

由于 Query Expansion 的全文检索可能带来许多非相关性的查询，因此在使用时需要非常谨慎。

**一个索引是否适合某个查询的“三星系统”**
* 索引将相关的记录放到一起则获得一星；
* 索引中的数据顺序和查找中的排练顺序一致则获得二星；
* 索引中的列包含了查询中需要的全部列则获得三星。
