---
title: OS-中断
date: 2018-04-11 20:49:21
tags: OS
---
**中断机制：让硬件在需要的时候向内核发出信号。**
中断本质上是一种特殊的电信号，由硬件设备发向处理器。处理器接收中断后，会马上向 OS 反映此信号的到来，然后 OS 负责处理这些新到来的数据。中断可以随时产生，因此内核随时可能因为新到来的中断而被打断。
{% asset_img 中断路由.PNG 中断从硬件到内核的路由 %}

_**中断（Interrupts） vs 异常（Exceptions）**_
在 OS 中，异常与中断不同，它在产生时必须考虑与处理器时钟同步，实际上，异常也称为**同步中断**。在处理器执行到由于编程失误而导致的错误指令（如被0除）或在执行期间出现特殊情况（如缺页），必须靠内核来处理的时候，处理器就会产生一个异常。很多处理器体系结构处理异常与处理中断的方法类似，因此，内核对它们的处理方式也很类似。一般，处理中断（硬件产生的异步中断）的方式，大部分也适用于处理异常（处理器本身产生的同步中断）。

**中断处理程序**
在响应一个特定中断的时候，内核会执行一个函数，该函数叫做中断处理程序（interrupt handler）或中断服务例程（Interrupt service routine ISR）。每种类型的中断都有一个相应的中断处理程序。一个设备的中断处理程序是其设备驱动程序（driver）的一部分——设备驱动程序是用于对设备进行管理的内核代码。

中断处理程序与其它内核函数真正的区别在于，中断处理程序是被内核调用来响应中断的，而它们运行于一个被称为**中断上下文（Interrupt context）**的特殊上下文中（也成原子上下文），该上下文中的执行代码不可阻塞。

**上半部分与下半部分**
鉴于中断处理程序既要运行得快，又要完成很多的工作量，一般把中断处理程序分为两个部分：
* 上半部（top half）：中断处理程序，接收到一个中断，立即开始执行，但只做有严格时限的工作，例如对接收的中断进行应答或复位硬件，该阶段可能禁止一些/全部其它中断；
* 下半部（bottom half）：能够被允许稍后完成的工作推迟到这个部分来完成，在合适的时机，下半部开始执行，该阶段可以响应所有中断。
_以网卡为例_ TBA

三种下半部接口：
* 软中断：中断上下文，相同类型的也允许同时执行，数据被软中断共享情况下需要锁；
* tasklet：中断上下文，自己负责执行的序列化保障，相同类型的tasklet不允许同时执行，所以不需要锁；
* 工作队列：进程上下文，需要锁来避免数据共享等问题。

**中断上下文（interrupt handler）**
（对比进程上下文），中断上下文和进程没有什么关系，与 current 宏也无关（尽管它会指向被中断的进程）。因为没有后备进程，中断上下文不睡眠（一旦睡眠就无法重新调度了）。因此不能从中断上下文调用某些（能够睡眠的）函数。
中断上下文打断了其它代码的执行（甚至打断在其他中断线上的另一中断处理程序），因此有严格的时间限制，应当迅速、简洁地完成，尽量不要用循环去处理繁重的工作。尽量把工作从中断处理程序（上半部）分离出来，放到下半部去执行。
中断处理程序的栈空间是专用的一个页，在 32 系统上为 4 KB。编写中断处理程序可以不关心栈如何设置或大小，但要尽量节约内核栈空间。
